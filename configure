#!/bin/bash
# vim: set filetype=sh

rm -f config.mk

echo "# Auto-generated by ./configure" >> config.mk

if ! [ -z ${CC+x} ]; then
  echo "CC = $CC" >> config.mk
fi
if ! [ -z ${CPP+x} ]; then
  echo "CPP = $CPP" >> config.mk
fi
if ! [ -z ${CFLAGS+x} ]; then
  echo "CFLAGS = $CFLAGS" >> config.mk
fi
if ! [ -z ${LDFLAGS+x} ]; then
  echo "LDFLAGS = $LDFLAGS" >> config.mk
fi
if ! [ -z ${LDLIBS+x} ]; then
  echo "LDLIBS = $LDLIBS" >> config.mk
fi

while [ "$1" != "" ]; do
  if [[ $1 == --prefix=* ]]; then
    echo "PREFIX = ${1#--prefix=}" >> config.mk
  elif [[ $1 == CC=* ]]; then
    echo "CC = ${1#CC=}" >> config.mk
  elif [[ $1 == CPP=* ]]; then
    echo "CPP = ${1#CPP=}" >> config.mk
  elif [[ $1 == CFLAGS=* ]]; then
    echo "CFLAGS = ${1#CFLAGS=}" >> config.mk
  elif [[ $1 == LDFLAGS=* ]]; then
    echo "LDFLAGS = ${1#LDFLAGS=}" >> config.mk
  elif [[ $1 == LDLIBS=* ]]; then
    echo "LDLIBS = ${1#LDLIBS=}" >> config.mk
  elif [[ $1 == --enable-debug ]]; then
    echo "DEBUG = 1" >> config.mk
  elif [[ $1 == --disable-debug ]]; then
    echo "DEBUG = 0" >> config.mk
  elif [[ $1 == --enable-shared ]]; then
    echo "SHARED = 1" >> config.mk
  elif [[ $1 == --disable-shared ]]; then
    echo "SHARED = 0" >> config.mk
  elif [[ $1 == --with-zlib ]]; then
    echo "USE_ZLIB = 1" >> config.mk
  elif [[ $1 == --with-zlib=* ]]; then
    echo "USE_ZLIB = 1" >> config.mk
    echo "LDFLAGS += -L${1#--with-zlib=}/lib" >> config.mk
    echo "LDLIBS += -lz" >> config.mk
  elif [[ $1 == --with-zlib-lib=* ]]; then
    echo "LDLIBS += ${1#--with-zlib-lib=}" >> config.mk
  elif [[ $1 == --with-zlib-include=* ]]; then
    echo "CFLAGS += ${1#--with-zlib-include=}" >> config.mk
  elif [[ $1 == --with-mpi ]]; then
    echo "USE_MPI = 1" >> config.mk
  elif [[ $1 == --without-mpi3 ]]; then
    echo "USE_MPI3 = 0" >> config.mk
  elif [[ $1 == --with-openmp ]]; then
    echo "LOOP_MODE = openmp" >> config.mk
  elif [[ $1 == --with-cuda ]]; then
    echo "LOOP_MODE = cuda" >> config.mk
  elif [[ $1 == --enable-xsdk-defaults ]]; then
    echo "XSDK = 1" >> config.mk
  elif [[ $1 == --disable-xsdk-defaults ]]; then
    echo "XSDK = 0" >> config.mk
  else
    echo "WARNING: ignoring option $1"
  fi
  shift
done

echo "XSDK ?= 0" >> config.mk
echo "DEBUG ?= \$(XSDK)" >> config.mk
echo "ifeq \"\$(DEBUG)\" \"1\"" >> config.mk
echo "  CFLAGS += -g -O0" >> config.mk
echo "endif" >> config.mk
echo "SHARED ?= \$(XSDK)" >> config.mk
echo "USE_MPI ?= \$(XSDK)" >> config.mk
